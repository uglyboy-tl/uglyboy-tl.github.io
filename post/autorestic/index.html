<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Autorestic | 打造一套完善的自动化数据备份方案 - 拾柒读库</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=author content="癸老师"><meta name=description content="原本是打算不再在这里写技术类博客了，结果最近的一个小成果确实没啥合适的地方存放，所以还是留在这里吧。 自从开始使用树莓派，忧虑的一个重要问题就"><meta name=keywords content="理论分享,心情日记,战略,共情">
<meta name=generator content="Hugo 0.92.1 with theme even">
<link rel=canonical href=https://www.uglyboy.cn/post/autorestic/>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<link href=/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous>
<meta property="og:title" content="Autorestic | 打造一套完善的自动化数据备份方案">
<meta property="og:description" content="原本是打算不再在这里写技术类博客了，结果最近的一个小成果确实没啥合适的地方存放，所以还是留在这里吧。 自从开始使用树莓派，忧虑的一个重要问题就">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.uglyboy.cn/post/autorestic/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-01-28T21:16:31+08:00">
<meta property="article:modified_time" content="2022-01-28T21:16:31+08:00">
<meta itemprop=name content="Autorestic | 打造一套完善的自动化数据备份方案">
<meta itemprop=description content="原本是打算不再在这里写技术类博客了，结果最近的一个小成果确实没啥合适的地方存放，所以还是留在这里吧。 自从开始使用树莓派，忧虑的一个重要问题就"><meta itemprop=datePublished content="2022-01-28T21:16:31+08:00">
<meta itemprop=dateModified content="2022-01-28T21:16:31+08:00">
<meta itemprop=wordCount content="1317">
<meta itemprop=keywords content="restic,docker,automation,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Autorestic | 打造一套完善的自动化数据备份方案">
<meta name=twitter:description content="原本是打算不再在这里写技术类博客了，结果最近的一个小成果确实没啥合适的地方存放，所以还是留在这里吧。 自从开始使用树莓派，忧虑的一个重要问题就"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>拾柒读库</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<a href=/>
<li class=mobile-menu-item>主页</li>
</a><a href=/post/>
<li class=mobile-menu-item>存档</li>
</a><a href=/tags/>
<li class=mobile-menu-item>标签</li>
</a><a href=/categories/>
<li class=mobile-menu-item>分类</li>
</a><a href=/about/>
<li class=mobile-menu-item>关于</li>
</a>
</ul>
</nav>
<div class=container id=mobile-panel>
<header id=header class=header>
<div class=logo-wrapper>
<a href=/ class=logo>拾柒读库</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=/>主页</a>
</li><li class=menu-item>
<a class=menu-item-link href=/post/>存档</a>
</li><li class=menu-item>
<a class=menu-item-link href=/tags/>标签</a>
</li><li class=menu-item>
<a class=menu-item-link href=/categories/>分类</a>
</li><li class=menu-item>
<a class=menu-item-link href=/about/>关于</a>
</li>
</ul>
</nav>
</header>
<main id=main class=main>
<div class=content-wrapper>
<div id=content class=content>
<article class=post>
<header class=post-header>
<h1 class=post-title>Autorestic | 打造一套完善的自动化数据备份方案</h1>
<div class=post-meta>
<span class=post-time> 2022-01-28 </span>
<div class=post-category>
<a href=/categories/%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/> 技术记录 </a>
</div>
<span class=more-meta> 约 1317 字 </span>
<span class=more-meta> 预计阅读 3 分钟 </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class="post-toc-content always-active">
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#备份方案的基本原则>备份方案的基本原则</a></li>
<li><a href=#数据备份方案的基本组件>数据备份方案的基本组件</a>
<ul>
<li><a href=#rclone>rclone</a></li>
<li><a href=#restichttpsresticnet><a href=https://restic.net/>restic</a></a></li>
<li><a href=#autorestichttpsautoresticvercelapp><a href=https://autorestic.vercel.app/>autorestic</a></a></li>
<li><a href=#crontab>crontab</a></li>
<li><a href=#docker>docker</a></li>
</ul>
</li>
<li><a href=#最终的数据自动化备份解决方案>最终的数据自动化备份解决方案</a>
<ul>
<li><a href=#features>Features</a></li>
<li><a href=#install>Install</a></li>
<li><a href=#usage>Usage</a></li>
<li><a href=#license>License</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<blockquote>
<p>原本是打算不再在这里写技术类博客了，结果最近的一个小成果确实没啥合适的地方存放，所以还是留在这里吧。</p>
</blockquote>
<p>自从开始使用树莓派，忧虑的一个重要问题就是：万一我的硬盘坏了可怎么办？通常的方案是硬盘组磁盘列阵，例如 raid1，raid5，raid10。可惜这套方案价格太高，不符合我用树莓派做 NAS 的风格。所以还是追求一套通常且通用的数据备份方案。</p>
<p>其间尝试了一些手段，例如：rclone，Duplicati，rsync，自己写 shell 脚本等等，但是如何构建一个完善的数据备份方案还是比较复杂的，需要考虑包括备份的可靠性，备份文件的大小（冗余程度），备份的版本管理，按不同时效留档等很多的要素。</p>
<p>最终，终于遇到了 <a href=https://autorestic.vercel.app/>automation</a>，并依此打造了一套完善的备份方案。</p>
<h2 id=备份方案的基本原则>备份方案的基本原则</h2>
<ul>
<li>备份数据要保证本地非源数据的硬盘保存一份，云端保存一份；</li>
<li>云端备份需要有数据加密机制；</li>
<li>备份数据需要有类似git的版本管理机制，保证冗余数据不被重复存储，且按版本标签可方便的管理；</li>
<li>云端保存需要支持各种云端数据源；</li>
<li>本地需要有旧版本文件清理机制；</li>
<li>可以对不同的数据源进行不同的备份机制设定；</li>
<li>自动化管理备份，无需过多的人工干预和介入；</li>
</ul>
<h2 id=数据备份方案的基本组件>数据备份方案的基本组件</h2>
<h3 id=rclone>rclone</h3>
<p>最早我是使用 rclone + shell 进行备份的，但是这只能解决云端备份和支持数据源的部分，而且设定异常的复杂。根本原因是在于，rclone其实是一款同步数据应用，而不是数据备份应用。</p>
<p>但现在有了一个良好的开端：可以将数据同步到任何云端网盘中了。</p>
<h3 id=restichttpsresticnet><a href=https://restic.net/>restic</a></h3>
<p>这是一款类似于rclone的软件，但是不同的是，restic是专注于备份的软件，支持加密传输，增量备份，快照记录等等，而且还可以同 rclone 联动，利用rclone支持多种云端的能力，将数据备份到各种网盘中。</p>
<p>另外，restic 也可以非常便捷的还原任何一个版本的数据，总得来说，是一个很简单便捷的备份工具。但它是一个命令行工具，也就是说，并不是一个服务，无法提供自动备份的功能（定时备份），而且每一项操作都需要运行相关命令加参数。</p>
<p>如此一来，关于备份这件事，就只剩下自动化版本管理这个问题需要解决了。</p>
<h3 id=autorestichttpsautoresticvercelapp><a href=https://autorestic.vercel.app/>autorestic</a></h3>
<p>autorestic是restic的一个「包装器」，通过自动调用restic的方法，加上了配置文件、定时执行（伪）等功能。将命令行程序扩展成了一个基于固定配置可重复运行的应用。</p>
<p>相关的命令说明还是需要自己看一下官方的文档。</p>
<p>但 autorestic 依然是一个命令行，不是服务，虽然提供了配置文件的方式可重复操作，但依然无法实现定时自动备份功能</p>
<h3 id=crontab>crontab</h3>
<p>autorestic 的官方文档推荐的方式即配合 crontab 每5分钟执行一次的方式 将 autorestic 配置成一个伪服务，进而提供定时自动备份功能。</p>
<h3 id=docker>docker</h3>
<p>最后，终极的解决方案，是需要将这些工具组合起来，形成一套完整的工具链。于是将对应的工具打包进docker image，就可以便捷的部署和使用对应的自动化备份方案了。</p>
<h2 id=最终的数据自动化备份解决方案>最终的数据自动化备份解决方案</h2>
<p>我通过 <a href=https://github.com/uglyboy-tl/autorestic-docker>Github</a> 的自动化流程，构建了实现上述 autorestic 服务的<a href=https://hub.docker.com/r/guixi/autorestic>镜像</a> ，使用说明如下：</p>
<h3 id=features>Features</h3>
<p>Often it is usefully to trigger backups automatically. So in this image, it would be trigger the command every 5min.</p>
<h3 id=install>Install</h3>
<ol>
<li>Create an initial config file (<code>autorestic.yml</code>) such as:</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=nt>locations</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>my-location</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=l>/data</span><span class=w>
</span><span class=w>    </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=l>my-backend</span><span class=w>
</span><span class=w>    </span><span class=nt>cron</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0 3 * * 0&#39;</span><span class=w> </span><span class=c># Every Sunday at 3:00</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>You can read full <a href=https://autorestic.vercel.app/config>docs</a> to configure it.
2. Create an empty file (<code>autorestic.lock.yml</code>)
3. run docker-compose as below:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>autorestic</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>guixi/autorestic</span><span class=w>
</span><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>autorestic</span><span class=w>
</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span><span class=w>      </span>- <span class=l>$(pwd)/autorestic.yml:/root/.autorestic.yml:ro</span><span class=w>
</span><span class=w>      </span>- <span class=l>$(pwd)/autorestic.lock.yml:/root/.autorestic.lock.yml</span><span class=w>
</span><span class=w>      </span>- <span class=l>~/.config/rclone/rclone.conf:/root/.config/rclone/rclone.conf:ro </span><span class=w> </span><span class=c>#optional</span><span class=w>
</span><span class=w>      </span>- <span class=l>my-volume:/data</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><h3 id=usage>Usage</h3>
<p>you can use autorestic to show all buckups such as</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>docker <span class=nb>exec</span> -it autorestic autorestic <span class=nb>exec</span> -av -- snapshots
</code></pre></td></tr></table>
</div>
</div><p>and also use restic directly such as</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>docker <span class=nb>exec</span> -it autorestic restic
</code></pre></td></tr></table>
</div>
</div><h3 id=license>License</h3>
<p><a href=https://github.com/uglyboy-tl/autorestic-docker/blob/main/LICENSE>MIT</a> © Uglyboy</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>癸老师</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2022-01-28
</span>
</p>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=/tags/restic/>restic</a>
<a href=/tags/docker/>docker</a>
<a href=/tags/automation/>automation</a>
</div>
<nav class=post-nav>
<a class=next href=/post/2022-01-19/>
<span class="next-text nav-default">2022 年 1 月 19 日</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
<div id=vcomments></div>
<script src=//cdn1.lncld.net/static/js/3.0.4/av-min.js></script>
<script src=//unpkg.com/valine/dist/Valine.min.js></script>
<script type=text/javascript>new Valine({el:'#vcomments',appId:'QRFTSzrN1UAJ7NcnFGmgQXf1-gzGzoHsz',appKey:'PXix8dYcL2jE47reeXwFXnNp',notify:!1,verify:!1,avatar:'mm',placeholder:'说点什么吧...',visitor:!1})</script>
</div>
</main>
<footer id=footer class=footer>
<div class=social-links>
<a href=mailto:uglyboy@uglyboy.cn class="iconfont icon-email" title=email></a>
<a href=https://github.com/uglyboy-tl class="iconfont icon-github" title=github></a>
<a href=https://www.uglyboy.cn/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a>
</div>
<div class=copyright>
<span class=power-by>
由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动
</span>
<span class=division>|</span>
<span class=theme-info>
主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span>
<span class=copyright-year>
&copy;
2021 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>癸老师</span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class="iconfont icon-up"></i>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js></script>
<script type=text/javascript>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script>
<script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script>
</body>
</html>